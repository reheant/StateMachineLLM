from sherpa_ai.actions.base import BaseAction
from util import refactor_transition_table_with_parent_states

class EventDrivenRefactorTransitionNamesAction(BaseAction):
    name: str = "event_driven_refactor_transition_names_action"
    args: dict = {}
    usage: str = "Given the hierarchical states and transitions of a UML state machine, refactor the names of the transitions to match the ParentState.ChildState format"


    def execute(self):
        print(f"Running {self.name}...")

        example_transitions_table = '<table border="1"><tr><th>From State</th><th>To State</th><th>Event</th><th>Guard</th><th>Action</th></tr><tr><td>Transportation Mode</td><td>Home Screen</td><td>PressSelectorToStart</td><td>NONE</td><td>Deactivate Transportation Mode</td></tr><tr><td>Transportation Mode</td><td>Home Screen</td><td>PressSelectorToTurnOn</td><td>NONE</td><td>NONE</td></tr><tr><td>Home Screen</td><td>Off State</td><td>HoldSelectorToTurnOff</td><td>NONE</td><td>Display confirmation message</td></tr><tr><td>Home Screen</td><td>Off State</td><td>AutomaticShutdown</td><td>NONE</td><td>Display warning message for 30 seconds</td></tr><tr><td>Home Screen</td><td>Home Screen</td><td>CancelAutomaticShutdown</td><td>Automatic shutdown warning active</td><td>Dismiss automatic shutdown warning</td></tr><tr><td>Home Screen</td><td>Recipe Selection</td><td>SelectRecipe</td><td>NONE</td><td>NONE</td></tr><tr><td> Home Screen </td><td> Recipe Selection </td><td> PlaceCookingBowl </td><td> NONE </td><td> NONE </td></tr><tr><td>Off State</td><td>Home Screen</td><td>PressSelectorToStart</td><td>NONE</td><td>Show Home Screen</td></tr><tr><td> Off State </td><td> Home Screen </td><td> PressSelectorToTurnOn </td><td> NONE </td><td> NONE </td></tr><tr><td> On State </td><td> Off State </td><td> HoldSelectorToTurnOff </td><td> NONE </td><td> NONE </td></tr><tr><td>On State</td><td>Off State</td><td>AutomaticShutdown</td><td>Inactive for 15 minutes</td><td>Display shutdown warning message</td></tr><tr><td>On State</td><td>Recipe Selection</td><td>SelectRecipe</td><td>NONE</td><td>NONE</td></tr><tr><td>On State</td><td>Home Screen (Post-Cooking)</td><td>RemoveCookingBowl</td><td>NONE</td><td>NONE</td></tr><tr><td>On State</td><td>Home Screen</td><td>PlaceCookingBowl</td><td>NONE</td><td>NONE</td></tr><tr><td>Automatic Shutdown Warning</td><td>Off State</td><td>HoldSelectorToTurnOff</td><td>NONE</td><td>Display confirmation message</td></tr><tr><td>Automatic Shutdown Warning</td><td>Off State</td><td>AutomaticShutdown</td><td>NONE</td><td>NONE</td></tr><tr><td>Automatic Shutdown Warning</td><td>Home Screen</td><td>CancelAutomaticShutdown</td><td>NONE</td><td>NONE</td></tr><tr><td> Automatic Shutdown Warning </td><td> Home Screen </td><td> RemoveCookingBowl </td><td> NONE </td><td> Display Home Screen </td></tr><tr><td>Automatic Shutdown Warning</td><td>Home Screen</td><td>PlaceCookingBowl</td><td>NONE</td><td>NONE</td></tr><tr><td> Recipe Selection </td><td> Off State </td><td> HoldSelectorToTurnOff </td><td> NONE </td><td> Display shutdown confirmation message </td></tr><tr><td>Recipe Selection</td><td>Ingredient Addition</td><td>SelectRecipe</td><td>NONE</td><td>NONE</td></tr><tr><td> Recipe Selection </td><td> Ingredient Addition </td><td> AddIngredients </td><td> NONE </td><td> NONE </td></tr><tr><td>Recipe Selection</td><td>Home Screen</td><td>RemoveCookingBowl</td><td>NONE</td><td>NONE</td></tr><tr><td>Recipe Selection</td><td>Ingredient Addition</td><td>PlaceCookingBowl</td><td>Cooking bowl correctly placed</td><td>NONE</td></tr><tr><td>Ingredient Addition</td><td>Off State</td><td>HoldSelectorToTurnOff</td><td>NONE</td><td>Show confirmation message and power down</td></tr><tr><td>Ingredient Addition</td><td>Chopping</td><td>AddIngredients</td><td>Correct amount of ingredients added</td><td>NONE</td></tr><tr><td> Ingredient Addition </td><td> Chopping </td><td> SelectNextStep </td><td> NONE </td><td> NONE </td></tr><tr><td>Ingredient Addition</td><td>Home Screen</td><td>RemoveCookingBowl</td><td>NONE</td><td>NONE</td></tr><tr><td>Chopping</td><td>Off State</td><td>HoldSelectorToTurnOff</td><td>NONE</td><td>Display confirmation message</td></tr><tr><td>Chopping</td><td>Cooking</td><td>SelectNextStep</td><td>NONE</td><td>NONE</td></tr><tr><td>Chopping</td><td>Error State</td><td>RemoveCookingBowl</td><td>NONE</td><td>NONE</td></tr><tr><td>Cooking</td><td>Off State</td><td>HoldSelectorToTurnOff</td><td>NONE</td><td>Display message to confirm switching off</td></tr><tr><td>Cooking</td><td>Ingredient Addition</td><td>AddIngredients</td><td>System prompts user</td><td>NONE</td></tr><tr><td> Cooking </td><td> Meal Ready </td><td> SelectNextStep </td><td> NONE </td><td> NONE </td></tr><tr><td>Cooking</td><td>Home Screen (Post-Cooking)</td><td>RemoveCookingBowl</td><td>NONE</td><td>NONE</td></tr><tr><td> Meal Ready </td><td> Off State </td><td> HoldSelectorToTurnOff </td><td> NONE </td><td> Display shutdown confirmation message </td></tr><tr><td>Meal Ready</td><td>Off State</td><td>AutomaticShutdown</td><td>Idle for 15 minutes</td><td>Display shutdown message</td></tr><tr><td>Meal Ready</td><td>Home Screen (Post-Cooking)</td><td>RemoveCookingBowl</td><td>NONE</td><td>NONE</td></tr><tr><td> Home Screen (Post-Cooking) </td><td> Off State </td><td> HoldSelectorToTurnOff </td><td> NONE </td><td> Display switch-off confirmation message </td></tr><tr><td>Home Screen (Post-Cooking)</td><td>Off State</td><td>AutomaticShutdown</td><td>NONE</td><td>Message appears for last 30 seconds</td></tr><tr><td>Home Screen (Post-Cooking)</td><td>Recipe Selection</td><td>SelectRecipe</td><td>NONE</td><td>NONE</td></tr><tr><td>Home Screen (Post-Cooking)</td><td>Home Screen</td><td>RemoveCookingBowl</td><td>NONE</td><td>NONE</td></tr><tr><td>Home Screen (Post-Cooking)</td><td>Home Screen</td><td>PlaceCookingBowl</td><td>NONE</td><td>NONE</td></tr><tr><td> Error State </td><td> Home Screen </td><td> PlaceCookingBowl </td><td> NONE </td><td> NONE </td></tr></table>'
        example_hierarchical_state_table = '<table border="1"><tr> <th>Superstate</th> <th>Substate</th> </tr><tr> <td> Inactive State </td> <td> Off State </td> </tr><tr> <td> Inactive State </td> <td> Home Screen </td> </tr><tr> <td> Inactive State </td> <td> Home Screen (Post-Cooking) </td> </tr><tr> <td> Cooking Process </td> <td> Recipe Selection </td> </tr><tr> <td> Cooking Process </td> <td> Ingredient Addition </td> </tr><tr> <td> Cooking Process </td> <td> Chopping </td> </tr><tr> <td> Cooking Process </td> <td> Cooking </td> </tr><tr> <td> Cooking Process </td> <td> Meal Ready </td> </tr><tr> <td> - </td> <td> Transportation Mode </td> </tr><tr> <td> - </td> <td> Error State </td> </tr></table>'
        event_driven_hierarchical_state_table = self.belief.get("event_driven_create_hierarchical_states_action", example_hierarchical_state_table)
        event_driven_transitions_table = self.belief.get("event_driven_create_transitions_action", example_transitions_table)

        refactored_event_driven_transitions_table = refactor_transition_table_with_parent_states(transitions_table=event_driven_transitions_table,
                                                                                                 hierarchical_state_table=event_driven_hierarchical_state_table)
        
        print(refactored_event_driven_transitions_table)
        return refactored_event_driven_transitions_table


